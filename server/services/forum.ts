import { client } from "../database";

type messageType = { author: string, value: string }

export { forumService }

const forumService = {
    addMessage,
    fetchMessages,
}

async function addMessage(message: messageType) {
    try {
        await client.query(`INSERT INTO messages (author, value, "creationDate") VALUES('${message.author}', '${escape(message.value)}', now());`)
    } catch (error) {
        console.error(error)
        throw new Error(`Could not insert the message ${JSON.stringify(message)} in the database.`)
    }
    return fetchMessages(message.author);
}

async function fetchMessages(userName: string) {
    const messages = (await client.query(`SELECT id, author, value FROM messages WHERE author=$1`, [userName])).rows.map(message => ({ ...message, value: unescape(message.value) }))
    return messages
}
