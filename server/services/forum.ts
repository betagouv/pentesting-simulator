import { client } from "../database";

type messageType = { author: string, value: string }

export { forumService }

const forumService = {
    addMessageToForum,
    fetchMessagesFromForum,
    testFetchMessagesFromForum
}

async function addMessageToForum(message: messageType) {
    try {
        await client.query(`INSERT INTO messages (author, value, "creationDate") VALUES('${message.author}', '${escape(message.value)}', now());`)
    } catch (error) {
        console.error(error)
        throw new Error(`Could not insert the message ${JSON.stringify(message)} in the database.`)
    }
    return fetchMessagesFromForum();
}

async function fetchMessagesFromForum() {
    const messages = (await client.query(`SELECT author, value FROM messages`)).rows.map(message => ({ ...message, value: unescape(message.value) }))
    return messages
}

async function testFetchMessagesFromForum() {
    const truc = await client.query(`SELECT * FROM messages`);
    console.log(truc.rows);
    return
}