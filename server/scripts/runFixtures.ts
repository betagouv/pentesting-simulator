import md5 from "md5";
import { client } from "../database"
import { characters, words } from "../fixtures"
import { stringFormatter } from "../utils";

runScript()

async function runScript() {
    client.connect();

    await runFixtures()

    client.end()
}

async function runFixtures() {
    await insertFlags();
    await insertCharacters();
    await insertTransfers()
}

async function insertTransfers() {
    await client.query(`TRUNCATE TABLE "transfers"`);
    const challengeSqlInjectionFlag1s = (await client.query(`SELECT value FROM flags WHERE "challengeName"='challengeSQLInjection1'`)).rows;
    if (challengeSqlInjectionFlag1s.length !== 1) {
        throw new Error(`Error while fetching flag for challengeName "challengeSqlInjection"`);
    }
    const challengeSqlInjectionFlag1: string = challengeSqlInjectionFlag1s[0].value;
    const flagAmount = 652;
    const flagAuthor = "Laureline";

    const transfers = " "
        .repeat(10000)
        .split("")
        .map(() => (
            {
                amount: Math.floor(Math.random() * 100) + flagAmount - 50,
                author: characters[Math.floor(Math.random() * characters.length)],
                code: computeRandomFlagValue(3)
            }
        ))
        .filter(({ amount, author }) => amount !== flagAmount || author !== flagAuthor)
    transfers.push({ amount: flagAmount, author: flagAuthor, code: challengeSqlInjectionFlag1 })
    transfers.sort(() => Math.random())

    return client.query(`INSERT INTO transfers (author, amount, code, "creationDate") VALUES ${transfers.map(transfer => `('${transfer.author}', ${transfer.amount}, '${transfer.code}',now())`).join(",")};`)
}

async function insertCharacters() {
    await client.query(`TRUNCATE TABLE "characters"`);
    const challengeSqlInjectionFlag2s = (await client.query(`SELECT value FROM flags WHERE "challengeName"='challengeSQLInjection2'`)).rows;
    if (challengeSqlInjectionFlag2s.length !== 1) {
        throw new Error(`Error while fetching flag for challengeName "challengeSqlInjection"`);
    }
    const challengeSqlInjectionFlag2 = challengeSqlInjectionFlag2s[0].value;

    return client.query(`INSERT INTO characters (name, hashedPassword, "creationDate") VALUES ${characters.map(character => `('${character}', '${character === "Bernard Lermite"
        ? challengeSqlInjectionFlag2
        : md5(
            Math.floor(Math.random() * 99999).toString()
        )
        }', now())`).join(",")};`)
}

async function insertFlags() {
    await client.query(`TRUNCATE TABLE "flags"`);
    const flagForm1 = { challengeName: "challengeForm1", value: computeRandomFlagValue(3) }
    const flagForm2 = { challengeName: "challengeForm2", value: computeRandomFlagValue(3) }
    const flagLowEncryption1 = { challengeName: "challengeLowEncryption1", value: computeRandomFlagValue(1) }
    const flagSQLInjection1 = { challengeName: "challengeSQLInjection1", value: computeRandomFlagValue(3) }
    const flagSQLInjection2 = { challengeName: "challengeSQLInjection2", value: md5(flagLowEncryption1.value) }
    const flagXSS = { challengeName: "challengeXSS1", value: computeRandomFlagValue(3) }

    const computedFlags = [flagForm1, flagForm2, flagSQLInjection1, flagSQLInjection2, flagLowEncryption1, flagXSS]

    return client.query(`INSERT INTO flags ("challengeName", "value") VALUES ${computedFlags.map(computedFlag => `('${computedFlag.challengeName}', '${computedFlag.value}')`).join(",")};`)
}

function computeRandomFlagValue(wordCount: number) {
    const numberOfWords = words.length;

    const computedWords = " ".repeat(wordCount).split("").map(() => { const index = Math.floor(Math.random() * numberOfWords); return words[index] })

    const computedFlag = computedWords.reduce((acc, computedWord, index) => index === 0 ? computedWord : acc + stringFormatter.capitalize(computedWord), "")
    return computedFlag
}


