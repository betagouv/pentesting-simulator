import { Request, Response } from "express"
import { forumService, characterService, flagService } from "./services"

type routeType = { method: "get" | "post", path: string, callback: (req: Request, res: Response) => Promise<void> | void }

export { routes }

const routes: Array<routeType> = [
    {
        method: "get",
        path: "/challenge1-endpoint/:phrase", callback: async (req, res) => {
            if (req.params.phrase === "Un chasseur sachant chasser sans son chien est un sacré chasseur") {
                const flag = await flagService.getFlag("challenge1")
                res.send(flag)
                return;
            } else {
                res.sendStatus(400)
            }
        }
    },
    {
        method: "get",
        path: "/challenge2-admin-cookie", callback: async (_, res) => {
            const flag = await flagService.getFlag("challenge2")
            res.send(flag)
        }
    },
    {
        method: "post",
        path: "/messages", callback: async (req, res) => {
            const message = req.body.message;
            if (message) {
                const messages = await forumService.addMessage(message);
                res.status(201)
                res.send(messages);
            } else {
                res.status(400)
                res.send("Le message n'a pas été posté.")
            }
        }
    },
    {
        method: "get",
        path: "/messages/:userName", callback: async (req, res) => {
            const userName = req.params.userName;
            if (typeof userName !== "string") {
                res.sendStatus(400)
                return;
            }
            const messages = await forumService.fetchMessages(userName)
            res.send(messages)
        }
    },
    {
        method: "get",
        path: "/characters/:id", callback: async (req, res) => {
            const id = req.params.id;
            const character = await characterService.getCharacterById(id);
            res.send(character);
        }
    },
    {
        method: "get",
        path: "/characters", callback: async (req, res) => {
            const character = await characterService.getCharacters();
            res.send(character);
        }
    },
    {
        method: "get",
        path: "/characters/:id", callback: async (req, res) => {
            const id = req.params.id
            const character = await characterService.getCharacterById(id);
            res.send(character);
        }
    },
    {
        method: "post",
        path: `/flags/guess`,
        callback: async (req, res) => {
            const { challengeName, flag } = req.body;
            const actualFlag = await flagService.getFlag(challengeName);
            if (actualFlag === flag) {
                res.send(true)
            } else {
                res.status(400);
                res.send(false)
            }
        }
    }]

