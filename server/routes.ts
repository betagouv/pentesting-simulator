import { Request, Response } from "express"
import { challenges } from "./challenges"
import { forumService } from "./services"

type routeType = { method: "get" | "post", path: string, callback: (req: Request, res: Response) => void }

export { routes }

const flagRoutes: Array<routeType> = Object.keys(challenges)
    .map((challengeName) => ({
        method: "get",
        path: `/${challengeName}`,
        callback: (req, res) => {
            if (req.query["flag"] === challenges[challengeName].flag) {
                res.send("YOUPI")
            } else {
                res.status(400);
                res.send("WRONG")
            }
        }
    }))

const routes: Array<routeType> = [
    {
        method: "get",
        path: "/challenge1-endpoint", callback: (_, res) => {
            res.send(challenges["challenge1"].flag)
        }
    },
    {
        method: "get",
        path: "/challenge2-endpoint", callback: (_, res) => {
            res.send(challenges["challenge2"].flag)
        }
    },
    {
        method: "post",
        path: "/challenge2/messages", callback: (req, res) => {
            const message = req.body.message;
            if (message) {
                const messages = forumService.addMessageToForum(message);
                res.status(201)
                res.send(messages);
            } else {
                res.status(400)
                res.send("Le message n'a pas été posté.")
            }
        }
    },
    {
        method: "get",
        path: "/challenge2/messages", callback: (req, res) => {
            const messages = forumService.fetchMessagesFromForum()
            res.send(messages)
        }
    },
    ...flagRoutes
]

