import { Request, Response } from "express"
import { challenges } from "./challenges"
import { forumService, characterService } from "./services"

type routeType = { method: "get" | "post", path: string, callback: (req: Request, res: Response) => Promise<void> | void }

export { routes }

const flagRoutes: Array<routeType> = Object.keys(challenges)
    .map((challengeName) => ({
        method: "get",
        path: `/${challengeName}`,
        callback: (req, res) => {
            if (req.query["flag"] === challenges[challengeName].flag) {
                res.send("YOUPI")
            } else {
                res.status(400);
                res.send("WRONG")
            }
        }
    }))

const routes: Array<routeType> = [
    {
        method: "get",
        path: "/challenge1-endpoint", callback: (_, res) => {
            res.send(challenges["challenge1"].flag)
        }
    },
    {
        method: "get",
        path: "/challenge2-admin-cookie", callback: (_, res) => {
            res.send(challenges["challenge2"].flag)
        }
    },
    {
        method: "post",
        path: "/messages", callback: async (req, res) => {
            const message = req.body.message;
            if (message) {
                const messages = await forumService.addMessage(message);
                res.status(201)
                res.send(messages);
            } else {
                res.status(400)
                res.send("Le message n'a pas été posté.")
            }
        }
    },
    {
        method: "get",
        path: "/messages", callback: async (req, res) => {
            const messages = await forumService.fetchMessages()
            res.send(messages)
        }
    },
    {
        method: "get",
        path: "/characters/:id", callback: async (req, res) => {
            const id = req.params.id;
            const character = await characterService.getCharacterById(id);
            res.send(character);
        }
    },
    {
        method: "get",
        path: "/characters", callback: async (req, res) => {
            const character = await characterService.getCharacters();
            res.send(character);
        }
    },
    {
        method: "get",
        path: "/characters/:id", callback: async (req, res) => {
            const id = req.params.id
            const character = await characterService.getCharacterById(id);
            res.send(character);
        }
    },
    ...flagRoutes
]

