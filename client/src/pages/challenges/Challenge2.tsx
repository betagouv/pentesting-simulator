import React, { ChangeEvent, FormEvent, useEffect, useState } from "react"
import { postMessageToForum, getMessagesFromForum } from "../../api";

export { Challenge2 }

type messageType = { author: string, value: string }

function Challenge2() {
    const [messageToPost, setMessageToPost] = useState("");
    const [author, setAuthor] = useState("");
    const [messages, setMessages] = useState<messageType[]>([]);
    useEffect(() => {
        getMessagesFromForum().then(({ data }) => {
            if (data) {
                setMessages(data as messageType[])
            }
        })
    }, [])
    return <>
        <header>Challenge 2</header>
        <p>L'administrateur vient souvent se balader sur cette page. Essayez de choper son cookie la prochaine fois qu'il vient !</p>
        <form onSubmit={onSubmit}>
            <input name="author" value={author} onChange={onChangeAuthor} />
            <input name="message" value={messageToPost} onChange={onChangeMessageToPost} />
            <button type="submit">Soumettre</button>
        </form>
        ---------------------------
        <ul>
            {messages.map((message, index) => <li key={message.value + index}>{message.author}<div dangerouslySetInnerHTML={{ __html: message.value }} /></li>)}
        </ul>
    </>

    function onChangeMessageToPost(e: ChangeEvent<HTMLInputElement>) {
        setMessageToPost(e.target.value);
    }

    function onChangeAuthor(e: ChangeEvent<HTMLInputElement>) {
        setAuthor(e.target.value);
    }

    async function onSubmit(event: FormEvent<HTMLFormElement>) {
        event.preventDefault();
        const { data, status } = await postMessageToForum({ value: messageToPost, author })
        if (status === 201) {
            setMessageToPost("")
            setMessages(data as messageType[]);
        }
    }

}
