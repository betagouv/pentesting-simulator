import React, { ChangeEvent, FormEvent, useState } from 'react'
import { useNavigate } from "react-router-dom";
import bcrypt from 'bcryptjs'
import { routes } from '../routes';
import { storage } from '../services';

export { Login }

function Login() {
    const [userName, setUserName] = useState("");
    const navigate = useNavigate()
    return (<>
        <form onSubmit={onSubmit}>
            <label htmlFor="userName" >Insérez votre nom d'utilisateur :</label>
            <input id="userName" name="userName" value={userName} onChange={onChangeUserName} />
            <button type="submit" disabled={!userName}>Soumettre</button>
        </form>
    </>)

    function onChangeUserName(e: ChangeEvent<HTMLInputElement>) {
        const forbiddenCharacters = /[ '"+-=]/
        if (!e.target.value.match(forbiddenCharacters)) {
            setUserName(e.target.value);
        }
    }

    async function onSubmit(event: FormEvent<HTMLFormElement>) {
        event.preventDefault();
        if (userName === "admin") {
            const password = prompt("Insérer votre mot de passe :") || "";
            const isPasswordFound = bcrypt.compareSync(password, "$2a$04$kP5Oz0bCa/IxBDSHiQ72TOtkgpAaPiB/bN1OIxfhD7/3vmmYjmZmS")
            if (isPasswordFound) {
                storage.user.setUserName(userName);
                storage.user.setPassword(password);
                navigate(routes["challenge2-set-admin-cookies"].getPath())
            }
        } else if (userName) {
            storage.user.setUserName(userName);
            navigate(routes["challenge-list"].getPath())
        }
    }
}